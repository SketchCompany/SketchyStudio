<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script>
        if(!localStorage.getItem("token")) open("/login?r=/studio", "_self")
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Outfit:wght@100..900&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

    <!-- custom resources -->
    <title>Studio | Sketchy Studio</title>
    <link rel="preconnect" href="https://api.sketch-company.de">
    <link rel="stylesheet" href="/res?f=css/project.css">

    <!-- imports from project -->
</head>
<body class="default">
    <sketchystudio>

    </sketchystudio>
    <script src="/res?f=studio.js"></script>
    <script>
        $(document).ready(async function(){
            const sketchyStudio = new SketchyStudio()
            const dialog = sketchyStudio.createDialog("LÃ¤dt", "Das Projekt wird geladen...", ``)

            const paths = location.pathname.replace("/", "").split("/")
            console.log("paths", paths)
            const projectName = decodeURI(paths[2 - 1])
            document.title = projectName + " | Sketchy Studio"
            const projectUrl = "/b/project/" + projectName
            let lastProject = localStorage.getItem("lastProject")
            let loaded = false
            if(lastProject){
                lastProject = JSON.parse(lastProject)
                console.log(lastProject)
                if(lastProject.name == projectName){
                    console.log("loaded project from localStorage")
                    const placeholder = new DOMParser().parseFromString(lastProject.html, "text/html")
                    console.log(placeholder)
                    document.title = placeholder.querySelector("title").innerHTML + " | Sketchy Studio"
                    $("html").attr("lang", placeholder.querySelector("html").getAttribute("lang"))
                    $("head").append([placeholder.querySelector("head").innerHTML, $(document.createElement("style")).html(lastProject.css)])
                    $("sketchystudio").append(placeholder.querySelector("body").innerHTML)
                    $("body").removeClass("default")
                    loaded = true
                    sketchyStudio.removeDialog(dialog)
                }
            }

            let html = await sketchyStudio.authGet(projectUrl + "/files?name=index.html", true)
            let css = await sketchyStudio.authGet(projectUrl + "/files?name=index.css", true)
            if(html.status == 0){
                sketchyStudio.notify("Fehlgeschlagen", html.err, "error", 10000)
                console.error(html.err)
                sketchyStudio.removeDialog(dialog)
                const dialog2 = sketchyStudio.createDialog("Laden Fehlgeschlagen", "Das laden des Projektes ist fehlgeschlagen, aufgrund folgendes Fehlers:", `<p class="bold">${html.err}</p>`, "error", 450)
                $(dialog2 + "-cancel").click(function(){
                    sketchyStudio.openSite("/studio")
                })
                return
            }
            else{
                html = html.data
                css = css.data
                if(!loaded){
                    const placeholder = new DOMParser().parseFromString(html, "text/html")
                    console.log(placeholder)
                    document.title = placeholder.querySelector("title").innerHTML + " | Sketchy Studio"
                    $("html").attr("lang", placeholder.querySelector("html").getAttribute("lang"))
                    $("head").append(placeholder.querySelector("head").innerHTML)
                    $("sketchystudio").append(placeholder.querySelector("body").innerHTML)
                    if(css.status == 0) sketchyStudio.notify("Fehlgeschlagen", css, "error", 10000)
                    else $("head").append($(document.createElement("style")).html(css))
                }
                $("body").removeClass("default")
                sketchyStudio.removeDialog(dialog)

                localStorage.setItem("lastProject", JSON.stringify({name: projectName, html, css}))
                console.log("updated project in localStorage")
            }

            if(sketchyStudio.isMobile()){
                const style = $(document.createElement("style"))
                style.html(`
                
                `)
                $("head").append(style)
            }
        })
    </script>
</body>
</html>